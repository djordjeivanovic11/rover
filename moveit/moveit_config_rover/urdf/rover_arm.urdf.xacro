<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="rover_arm">
  
  <!-- ========================================================================= -->
  <!-- ROVER ARM URDF FOR MOVEIT                                                 -->
  <!-- ========================================================================= -->
  <!-- This URDF describes the 5-DOF rover arm extracted from the main rover    -->
  <!-- URDF for use with MoveIt. It includes the arm structure only.            -->
  <!-- ========================================================================= -->
  
  <!-- Parameters -->
  <xacro:property name="use_sim" value="true" />
  
  <!-- Base link (world-fixed for MoveIt planning) -->
  <link name="base_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.1 0.1 0.05"/>
      </geometry>
      <material name="grey">
        <color rgba="0.5 0.5 0.5 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.1 0.1 0.05"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
    </inertial>
  </link>

  <!-- Arm Base Link (first rotating joint) -->
  <link name="arm_base">
    <inertial>
      <origin xyz="0.00269121782025528 -0.0736193849501603 2.99403082272554E-06" rpy="0 0 0"/>
      <mass value="1.21984121425323"/>
      <inertia
        ixx="0.00289430802459876"
        ixy="0.0"
        ixz="0.0"
        iyy="0.00362400719320402"
        iyz="-1.63416065266398E-08"
        izz="0.00142025470103719"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Base.STL"/>
      </geometry>
      <material name="ArmOrange">
        <color rgba="1.0 0.5 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Base.STL"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_to_arm" type="fixed">
    <origin xyz="0 0 0.025" rpy="1.5708 0 0"/>
    <parent link="base_link"/>
    <child link="arm_base"/>
  </joint>

  <!-- Joint 1: Base Rotation (Continuous - matches real hardware) -->
  <joint name="AB_Rev" type="continuous">
    <origin xyz="0 -0.032925 0" rpy="0 0 0"/>
    <parent link="arm_base"/>
    <child link="arm_stage1"/>
    <axis xyz="0 0 1"/>
  </joint>

  <!-- Arm Stage 1 Link -->
  <link name="arm_stage1">
    <inertial>
      <origin xyz="-0.00020628223126179 0.227191684872917 -9.31851003443951E-08" rpy="0 0 0"/>
      <mass value="2.05584940619067"/>
      <inertia
        ixx="0.00413647412293572"
        ixy="1.79213187222989E-07"
        ixz="2.52864476861688E-10"
        iyy="0.00189852055804283"
        iyz="3.98678971652827E-07"
        izz="0.00426572376138632"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Stage1.STL"/>
      </geometry>
      <material name="ArmOrange">
        <color rgba="1.0 0.5 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Stage1.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- Joint 2: Shoulder Pitch (Forward/Backward) -->
  <joint name="AS1_Rev" type="revolute">
    <origin xyz="0 0.44841 0" rpy="0 0 0"/>
    <parent link="arm_stage1"/>
    <child link="arm_stage1_mount"/>
    <axis xyz="0 1 0"/>
    <limit lower="-2.618" upper="2.618" effort="40.0" velocity="1.0"/>
  </joint>

  <!-- Mount link for second shoulder joint -->
  <link name="arm_stage1_mount">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.01"/>
      <inertia ixx="1e-4" ixy="0" ixz="0" iyy="1e-4" iyz="0" izz="1e-4"/>
    </inertial>
  </link>

  <!-- Joint 3: Shoulder Yaw (Left/Right) - Z-axis for true 3D spherical motion -->
  <joint name="AS2_Rev" type="revolute">
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <parent link="arm_stage1_mount"/>
    <child link="arm_stage2"/>
    <axis xyz="0 0 1"/>
    <limit lower="-2.618" upper="2.618" effort="30.0" velocity="1.2"/>
  </joint>

  <!-- Arm Stage 2 Link -->
  <link name="arm_stage2">
    <inertial>
      <origin xyz="0.000764848055373635 0.108004021660145 -7.41021655881191E-06" rpy="0 0 0"/>
      <mass value="1.10641868195103"/>
      <inertia
        ixx="0.00203036588347499"
        ixy="1.2016455250978E-07"
        ixz="8.93638502070084E-09"
        iyy="0.000724056837132394"
        iyz="-2.59723147049563E-07"
        izz="0.00167896852167445"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Stage2.STL"/>
      </geometry>
      <material name="ArmOrange">
        <color rgba="1.0 0.5 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Stage2.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- Joint 4: Elbow Pitch -->
  <joint name="AW_Rev" type="revolute">
    <origin xyz="0 0.24374 0" rpy="0 0 0"/>
    <parent link="arm_stage2"/>
    <child link="arm_wrist"/>
    <axis xyz="0 1 0"/>
    <limit lower="-3.1416" upper="3.1416" effort="25.0" velocity="1.5"/>
  </joint>

  <!-- Arm Wrist Link -->
  <link name="arm_wrist">
    <inertial>
      <origin xyz="4.19332298329245E-08 0.112707914183881 9.17438099549139E-05" rpy="0 0 0"/>
      <mass value="0.497824704654945"/>
      <inertia
        ixx="0.000376169945859592"
        ixy="0.0"
        ixz="0.0"
        iyy="0.000316899458887731"
        iyz="1.8032974829919E-07"
        izz="0.000376086003282618"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Wrist.STL"/>
      </geometry>
      <material name="ArmOrange">
        <color rgba="1.0 0.5 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Wrist.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- Joint 5: Wrist Roll -->
  <joint name="AM_Rev" type="revolute">
    <origin xyz="0 0.15939 0" rpy="0 0 0"/>
    <parent link="arm_wrist"/>
    <child link="arm_manip"/>
    <axis xyz="0 0 1"/>
    <limit lower="-3.1416" upper="3.1416" effort="15.0" velocity="2.0"/>
  </joint>

  <!-- Arm Manipulator (End Effector) Link -->
  <link name="arm_manip">
    <inertial>
      <origin xyz="-0.000898036264171731 0.064805984623544 -6.62278032415031E-08" rpy="0 0 0"/>
      <mass value="0.463838309678963"/>
      <inertia
        ixx="0.000241695544012855"
        ixy="3.64942774249902E-08"
        ixz="-3.03541463488142E-09"
        iyy="0.000262320130752642"
        iyz="1.01793631610372E-09"
        izz="0.000181604991372017"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Manip.STL"/>
      </geometry>
      <material name="ManipulatorRed">
        <color rgba="0.8 0.0 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 -1.5708 0"/>
      <geometry>
        <mesh filename="package://rover_description/meshes/Arm-Manip.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- Tool Center Point (TCP) - end effector frame for MoveIt -->
  <link name="tool_flange">
    <inertial>
      <mass value="0.01"/>
      <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.0001"/>
    </inertial>
  </link>

  <joint name="manip_to_tcp" type="fixed">
    <origin xyz="0 0.08 0" rpy="0 0 0"/>
    <parent link="arm_manip"/>
    <child link="tool_flange"/>
  </joint>

  <!-- ========================================================================= -->
  <!-- ROS2 CONTROL INTERFACE                                                    -->
  <!-- ========================================================================= -->
  <ros2_control name="RoverArmSystem" type="system">
    <hardware>
      <xacro:if value="${use_sim}">
        <plugin>mock_components/GenericSystem</plugin>
        <param name="mock_sensor_commands">true</param>
        <param name="state_following_offset">0.0</param>
      </xacro:if>
      <xacro:unless value="${use_sim}">
        <plugin>topic_based_ros2_control/TopicBasedSystem</plugin>
        <param name="joint_commands_topic">/arm_joint_commands</param>
        <param name="joint_states_topic">/arm_joint_states</param>
      </xacro:unless>
    </hardware>
    
    <!-- Joint interfaces - keep minimal, limits are on joint definitions above -->
    <joint name="AB_Rev">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    
    <joint name="AS1_Rev">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    
    <joint name="AS2_Rev">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    
    <joint name="AW_Rev">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    
    <joint name="AM_Rev">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

</robot>
